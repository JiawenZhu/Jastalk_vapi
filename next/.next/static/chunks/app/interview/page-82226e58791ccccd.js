(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[699],{422:function(e,t,n){Promise.resolve().then(n.bind(n,8897)),Promise.resolve().then(n.bind(n,1523)),Promise.resolve().then(n.bind(n,49))},8897:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return y}});var a,l=n(7437),s=n(2265),i=n(5956),o=n(8208),r=n(7608),c=n(8844),d=n(7892),u=n(3734),m=n(7819),p=n(8399),v=n(9376),x=n(9628),h=n(2618),f=n(257);let g=(void 0!==f&&(null===(a=f.env)||void 0===a?void 0:a.NEXT_PUBLIC_SERVER_URL)||"").replace(/\/$/,"");function y(){let e=(0,v.useRouter)(),t=(0,v.useSearchParams)(),[n,a]=(0,s.useState)(null),[f,y]=(0,s.useState)(!1),[b,w]=(0,s.useState)(!1),[j,N]=(0,s.useState)(!0),[C,S]=(0,s.useState)(!1),[_,k]=(0,s.useState)(null),[E,L]=(0,s.useState)(!1),[T,R]=(0,s.useState)(""),[z,D]=(0,s.useState)(""),[O,B]=(0,s.useState)("Frontend Development"),[q,P]=(0,s.useState)(""),U=(0,s.useMemo)(()=>new h.p,[]);(0,s.useEffect)(()=>{if(!t)return;let e=t.get("role")||"",n=t.get("interview_type")||"",a=t.get("questions")||"",l=t.get("autostart");e&&D(e),n&&B(n),a&&P(a.replaceAll("\n","\n")),l&&"0"!==l&&"false"!==l.toLowerCase()&&setTimeout(()=>en().catch(()=>{}),100)},[t]),(0,s.useEffect)(()=>{let e=new x.Jh({enableCam:!1,enableMic:!0,transport:U,params:{baseUrl:g.replace(/\/api$/,""),endpoints:{connect:"/api/bot/connect",action:"/api/bot/action"},requestData:{bot_profile:"interviewer"}}});return a(e),()=>{try{e.disconnect()}catch(e){}}},[U]),(0,s.useEffect)(()=>{var t,a,l;if(!n)return;let s=()=>L(!0),i=()=>{if(L(!1),_){let t=G?"?sessionId=".concat(encodeURIComponent(G)):"";e.push("/results/".concat(_).concat(t))}},o=()=>L(!1);return null===(t=n.on)||void 0===t||t.call(n,x.Lz.RecordingStarted,s),null===(a=n.on)||void 0===a||a.call(n,x.Lz.RecordingStopped,i),null===(l=n.on)||void 0===l||l.call(n,x.Lz.RecordingError,o),()=>{try{var e,t,a;null===(e=n.off)||void 0===e||e.call(n,x.Lz.RecordingStarted,s),null===(t=n.off)||void 0===t||t.call(n,x.Lz.RecordingStopped,i),null===(a=n.off)||void 0===a||a.call(n,x.Lz.RecordingError,o)}catch(e){}}},[n,_,G,e]);let[Z,I]=(0,s.useState)([]),[J,M]=(0,s.useState)([]),A=(0,s.useCallback)(e=>{M(t=>[{t:new Date().toLocaleTimeString(),type:e},...t].slice(0,200))},[]);(0,s.useEffect)(()=>{if(!n)return;let e=e=>{let t="string"==typeof e?e:(null==e?void 0:e.text)||(null==e?void 0:e.message)||JSON.stringify(e);I(e=>[...e,{role:"user",text:t}]),W(e=>e?"".concat(e,"\n").concat(t):t),A("user-transcript")},t=e=>{let t="string"==typeof e?e:(null==e?void 0:e.text)||(null==e?void 0:e.message)||JSON.stringify(e);I(e=>[...e,{role:"bot",text:t}]),A("bot-transcript")},a=()=>A("connected"),l=()=>A("disconnected"),s=()=>A("bot-started"),i=()=>A("bot-stopped");try{var o,r,c,d,u,m;null===(o=n.on)||void 0===o||o.call(n,x.Lz.UserTranscript,e),null===(r=n.on)||void 0===r||r.call(n,x.Lz.BotTranscript,t),null===(c=n.on)||void 0===c||c.call(n,x.Lz.Connected,a),null===(d=n.on)||void 0===d||d.call(n,x.Lz.Disconnected,l),null===(u=n.on)||void 0===u||u.call(n,x.Lz.BotStarted,s),null===(m=n.on)||void 0===m||m.call(n,x.Lz.BotStopped,i)}catch(e){}return()=>{try{var o,r,c,d,u,m;null===(o=n.off)||void 0===o||o.call(n,x.Lz.UserTranscript,e),null===(r=n.off)||void 0===r||r.call(n,x.Lz.BotTranscript,t),null===(c=n.off)||void 0===c||c.call(n,x.Lz.Connected,a),null===(d=n.off)||void 0===d||d.call(n,x.Lz.Disconnected,l),null===(u=n.off)||void 0===u||u.call(n,x.Lz.BotStarted,s),null===(m=n.off)||void 0===m||m.call(n,x.Lz.BotStopped,i)}catch(e){}}},[n,A]);let F=(0,s.useCallback)(async e=>{let t=q.split(/\r?\n/).map(e=>e.trim()).filter(Boolean),n=await fetch("".concat(g,"/conversations"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,role:z||void 0,interview_type:O||void 0,questions:t.length?t:void 0,metadata:{}})});if(!n.ok)throw Error("Create conversation failed: ".concat(n.status));return(await n.json()).conversation_id},[]),[G,V]=(0,s.useState)(null),[X,$]=(0,s.useState)(null),[H,K]=(0,s.useState)(null),[Q,W]=(0,s.useState)(""),Y=(0,s.useCallback)(async()=>{var e,t,n;let a=await fetch("".concat(g,"/interview/create"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({interview_type:O})});if(!a.ok)throw Error("create session failed: ".concat(a.status));let l=await a.json(),s=null==l?void 0:null===(e=l.data)||void 0===e?void 0:e.session_id;if(!s)throw Error("missing session_id");V(s);let i=await fetch("".concat(g,"/interview/").concat(s,"/start"),{method:"POST"});if(!i.ok)throw Error("start failed: ".concat(i.status));let o=await i.json();return $((null==o?void 0:null===(t=o.data)||void 0===t?void 0:t.current_question)||null),K((null==o?void 0:null===(n=o.data)||void 0===n?void 0:n.progress)||null),s},[O]),ee=(0,s.useCallback)(async()=>{var e,t,n;if(!G)return;let a=await fetch("".concat(g,"/interview/").concat(G,"/response"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:Q,transcription:Q})});if(!a.ok)throw Error("response failed: ".concat(a.status));let l=await a.json();W(""),$((null==l?void 0:null===(e=l.data)||void 0===e?void 0:e.next_question)||null),K((null==l?void 0:null===(t=l.data)||void 0===t?void 0:t.progress)||null),(null==l?void 0:null===(n=l.data)||void 0===n?void 0:n.is_complete)&&await et()},[G,Q]),et=(0,s.useCallback)(async()=>{try{if(G&&await fetch("".concat(g,"/interview/").concat(G,"/complete"),{method:"POST"}),await eo(),_){let t=G?"?sessionId=".concat(encodeURIComponent(G)):"";e.push("/results/".concat(_).concat(t))}}catch(e){console.error(e)}},[G,_,eo,e]),en=(0,s.useCallback)(async()=>{if(n){R(""),y(!0);try{let t=await F("Voice Interview");k(t),await Y();try{await n.initDevices(),n.enableMic(!0),n.enableCam(!1)}catch(e){}if("function"==typeof n.startBot)await n.startBot({requestData:{bot_profile:"interviewer",conversation_id:t,interview_type:""}});else{var e;let a=await fetch("".concat(g,"/bot/connect"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bot_profile:"interviewer",conversation_id:t,interview_type:""})});if(!a.ok)throw Error("connect failed: ".concat(a.status));let l=await a.json();console.log("[connect] server payload (next):",l);let s=("string"==typeof(null==l?void 0:l.url)&&l.url||"string"==typeof(null==l?void 0:l.room_url)&&l.room_url||"string"==typeof(null==l?void 0:null===(e=l.room)||void 0===e?void 0:e.url)&&l.room.url||"").trim(),i="string"==typeof(null==l?void 0:l.token)?l.token:"";if(!s||!i)throw Error("connect endpoint missing fields. url:".concat(s?"ok":"missing"," token:").concat(i?"ok":"missing"));let o="undefined"!=typeof AbortController?new AbortController:void 0;console.log("[connect] trying auth bundles in order (next)");let r=!1;for(let e of[{room_url:s,token:i},{url:s,token:i},{auth:{room_url:s,token:i}},{auth:{url:s,token:i}},{daily:{room_url:s,token:i}},{daily:{url:s,token:i}},{room:{url:s},token:i}])try{await n.connect(e,o),r=!0;break}catch(t){console.warn("[connect] attempt failed (next) with bundle:",e,t)}if(!r)throw Error("All connect bundle attempts failed")}w(!0),A("connected")}catch(e){console.error(e),R((null==e?void 0:e.message)||"Failed to start interview")}finally{y(!1)}}},[n,F]),ea=(0,s.useCallback)(async()=>{try{null==n||n.disconnect()}catch(e){}w(!1),A("disconnected")},[n]),el=(0,s.useCallback)(()=>{N(e=>{try{null==n||n.enableMic(!e)}catch(e){}return!e})},[n]),es=(0,s.useCallback)(()=>{S(e=>{try{null==n||n.enableCam(!e)}catch(e){}return!e})},[n]),ei=(0,s.useCallback)(async()=>{if(!n||!_)return;let e={service:"daily",action:"start_recording",arguments:[{name:"conversation_id",value:_},{name:"type",value:"cloud"},{name:"streaming_settings",value:{width:1280,height:720,fps:30}},{name:"include_audio",value:!0},{name:"include_video",value:!1}]};try{"function"==typeof n.sendClientRequest?await n.sendClientRequest("client-message",e):"function"==typeof n.action&&await n.action(e)}catch(e){console.error(e)}},[n,_]),eo=(0,s.useCallback)(async()=>{if(!n||!_)return;let e={service:"daily",action:"stop_recording",arguments:[{name:"conversation_id",value:_}]};try{"function"==typeof n.sendClientRequest?await n.sendClientRequest("client-message",e):"function"==typeof n.action&&await n.action(e)}catch(e){console.error(e)}},[n,_]),[er,ec]=(0,s.useState)(""),ed=(0,s.useCallback)(async()=>{if(!er.trim()||!n)return;let e=er.trim();I(t=>[...t,{role:"user",text:e}]),ec("");try{"function"==typeof n.sendText?await n.sendText(e,{run_immediately:!0}):"function"==typeof n.sendClientRequest?await n.sendClientRequest("client-message",{service:"llm",action:"append_to_messages",arguments:[{name:"messages",value:[{role:"user",content:[{type:"text",text:e}]}]}]}):"function"==typeof n.action&&await n.action({service:"llm",action:"append_to_messages",arguments:[{name:"messages",value:[{role:"user",content:[{type:"text",text:e}]}]}]}),A("user-message")}catch(e){console.error(e)}},[n,er,A]);return(0,l.jsxs)("div",{className:"max-w-6xl mx-auto py-10 px-6",children:[(0,l.jsx)("h1",{className:"text-2xl font-semibold",children:"Pipecat + Gemini 面试"}),(0,l.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"使用 Daily 存储音视频；录制结束后跳转到结果页显示。"}),T?(0,l.jsx)("div",{className:"mt-4 p-3 rounded bg-red-50 text-red-700 text-sm",children:T}):null,b?(0,l.jsxs)("div",{className:"mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,l.jsxs)("div",{className:"lg:col-span-1 border rounded p-4 bg-gray-50",children:[(0,l.jsx)("div",{className:"text-sm text-gray-500 mb-2",children:"Bot audio"}),(0,l.jsx)("div",{className:"h-16 rounded bg-black/80 text-white flex items-center justify-center tracking-widest",children:"●●●●●"}),(0,l.jsxs)("div",{className:"mt-4 flex flex-wrap gap-2",children:[(0,l.jsxs)("button",{onClick:el,className:"inline-flex items-center gap-2 bg-gray-100 px-3 py-2 rounded",children:[j?(0,l.jsx)(r.Z,{className:"h-4 w-4"}):(0,l.jsx)(c.Z,{className:"h-4 w-4"}),j?"麦克风开":"麦克风关"]}),(0,l.jsxs)("button",{onClick:es,className:"inline-flex items-center gap-2 bg-gray-100 px-3 py-2 rounded",children:[C?(0,l.jsx)(d.Z,{className:"h-4 w-4"}):(0,l.jsx)(u.Z,{className:"h-4 w-4"}),C?"摄像头开":"摄像头关"]}),E?(0,l.jsxs)("button",{onClick:eo,className:"inline-flex items-center gap-2 bg-orange-600 text-white px-4 py-2 rounded",children:[(0,l.jsx)(m.Z,{className:"h-4 w-4"})," 停止录制"]}):(0,l.jsxs)("button",{onClick:ei,className:"inline-flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded",children:[(0,l.jsx)(o.Z,{className:"h-4 w-4"})," 开始录制"]}),(0,l.jsx)("button",{onClick:ea,className:"inline-flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded",children:"结束面试"})]}),X&&(0,l.jsxs)("div",{className:"mt-4 text-sm",children:[(0,l.jsx)("div",{className:"text-gray-500 mb-1",children:"当前问题"}),(0,l.jsx)("div",{className:"font-medium",children:X.question}),(0,l.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["难度：",X.difficulty," \xb7 类别：",X.category]})]}),(0,l.jsx)("div",{className:"mt-4",children:(0,l.jsxs)("button",{onClick:ee,className:"inline-flex items-center gap-2 bg-gray-800 text-white px-4 py-2 rounded",children:[(0,l.jsx)(p.Z,{className:"h-4 w-4"})," 下一题"]})})]}),(0,l.jsxs)("div",{className:"lg:col-span-2 border rounded p-4",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,l.jsx)("div",{className:"font-medium",children:"Transcript (live)"}),(0,l.jsxs)("div",{className:"text-xs text-gray-500",children:[Z.length," messages"]})]}),(0,l.jsxs)("div",{className:"space-y-2 max-h-[50vh] overflow-auto",children:[Z.map((e,t)=>(0,l.jsxs)("div",{className:"p-2 rounded ".concat("user"===e.role?"bg-blue-50":"bg-gray-100"),children:[(0,l.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:e.role}),(0,l.jsx)("div",{className:"whitespace-pre-wrap",children:e.text})]},t)),0===Z.length&&(0,l.jsx)("div",{className:"text-sm text-gray-500",children:"暂无内容"})]}),(0,l.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,l.jsx)("input",{value:er,onChange:e=>ec(e.target.value),placeholder:"Type message here",className:"flex-1 border rounded px-3 py-2"}),(0,l.jsx)("button",{onClick:ed,className:"bg-gray-800 text-white px-4 py-2 rounded",children:"发送"})]})]}),(0,l.jsxs)("div",{className:"lg:col-span-3 border rounded p-4",children:[(0,l.jsx)("div",{className:"font-medium mb-2",children:"Events"}),(0,l.jsxs)("div",{className:"grid gap-1 text-sm max-h-48 overflow-auto",children:[J.map((e,t)=>(0,l.jsxs)("div",{className:"flex justify-between text-gray-600",children:[(0,l.jsx)("span",{children:e.t}),(0,l.jsx)("span",{children:e.type})]},t)),0===J.length&&(0,l.jsx)("div",{className:"text-gray-500",children:"尚无事件"})]})]})]}):(0,l.jsxs)("div",{className:"mt-6",children:[(0,l.jsxs)("div",{className:"grid gap-3 mb-4",children:[(0,l.jsxs)("label",{className:"text-sm",children:["职位（可选）",(0,l.jsx)("input",{value:z,onChange:e=>D(e.target.value),placeholder:"如：前端工程师",className:"mt-1 w-full border rounded px-3 py-2"})]}),(0,l.jsxs)("label",{className:"text-sm",children:["面试类型（可选）",(0,l.jsx)("select",{value:O,onChange:e=>B(e.target.value),className:"mt-1 w-full border rounded px-3 py-2",children:["Frontend Development","Backend Development","Full Stack Development","Software Engineering","Cloud Engineering","DevOps Engineering","Mobile Development","Game Development","Security Engineering","Blockchain Development"].map(e=>(0,l.jsx)("option",{value:e,children:e},e))})]}),(0,l.jsxs)("label",{className:"text-sm",children:["题目（每行一题，可选）",(0,l.jsx)("textarea",{value:q,onChange:e=>P(e.target.value),placeholder:"示例:\n请自我介绍\n讲一个你解决复杂问题的经历",rows:4,className:"mt-1 w-full border rounded px-3 py-2"})]})]}),(0,l.jsxs)("button",{onClick:en,disabled:f||!g,className:"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50",children:[f?(0,l.jsx)(i.Z,{className:"h-4 w-4 animate-spin"}):(0,l.jsx)(o.Z,{className:"h-4 w-4"}),"开始语音面试"]}),!g&&(0,l.jsx)("p",{className:"text-xs text-red-500 mt-2",children:"请设置 NEXT_PUBLIC_SERVER_URL 指向 Gemini 服务的 /api，例如 http://127.0.0.1:7860/api"})]})]})}}},function(e){e.O(0,[985,570,417,971,117,744],function(){return e(e.s=422)}),_N_E=e.O()}]);